<!DOCTYPE html>
<html>
<head>
    <title>MetaData Refiner</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital@0;1&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            line-height: 1.6;
        }
        .image-card { 
            margin: 1rem; 
            padding: 1rem; 
            border: 1px solid #ddd; 
            border-radius: 8px;
            transition: background-color 0.3s ease;
            position: relative;
        }
        @keyframes breathing {
            0% { background-color: #f8f9fa; border-color: #0d6efd; }
            50% { background-color: #e9ecef; border-color: #0b5ed7; }
            100% { background-color: #f8f9fa; border-color: #0d6efd; }
        }
        .image-card.processing {
            animation: breathing 2s ease-in-out infinite;
            background-color: #f8f9fa;
            border-color: #0d6efd;
        }
        .image-card.complete {
            background-color: #d1e7dd;
            border-color: #198754;
        }
        #drop-zone { 
            border: 2px dashed #ccc; 
            padding: 2rem; 
            text-align: center; 
            margin: 1rem 0; 
        }
        .dragover { 
            border-color: #0d6efd; 
            background-color: #f8f9fa; 
        }
        #cost-estimate {
            margin-top: 1rem;
            padding: 1rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f8f9fa;
        }
        #logo {
            height: 60px;
            width: auto;
        }
        .generate-single {
            background-color: #469DB4;
            border-color: #469DB4;
            color: #fff;
        }
        .delete-btn {
            position: absolute;
            top: -16px;
            right: -16px;
            padding: 0.16rem 0.5rem;
        }
        #generate-all {
            background-color: #469DB4;
            border-color: #469DB4;
        }
        #export {
            background-color: darkblue;
            border-color: darkblue;
        }
        
        /* Dark mode styles */
        [data-bs-theme="dark"] .image-card { 
            border-color: #495057;
            background-color: #212529;
        }
        [data-bs-theme="dark"] .image-card.processing {
            background-color: #1a1d29;
            border-color: #0d6efd;
        }
        [data-bs-theme="dark"] .image-card.complete {
            background-color: #0f2027;
            border-color: #198754;
        }
        [data-bs-theme="dark"] #drop-zone { 
            border-color: #495057; 
            background-color: #343a40;
            color: #f8f9fa;
        }
        [data-bs-theme="dark"] .dragover { 
            border-color: #0d6efd; 
            background-color: #495057; 
        }
        [data-bs-theme="dark"] #cost-estimate {
            border-color: #495057;
            background-color: #343a40;
            color: #f8f9fa;
        }
        .logo-fill {
            fill: #231f20;
        }
        [data-bs-theme="dark"] .logo-fill {
            fill: #ffffff;
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 aria-label="MetaData Refiner">
                <svg id="logo" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 387.89 89.6" style="height: 60px; width: auto;">
                    <path class="logo-fill" d="M21.54,38.83V6.76c0-.48.29-.77.77-.77h8.88c.48,0,.77.24,1.06.72l14.74,24.05h.62l14.74-24.05c.29-.48.58-.72,1.06-.72h8.88c.48,0,.77.29.77.77v32.07c0,.48-.29.77-.77.77h-6.14c-.48,0-.72-.29-.72-.77v-22.61h-.53l-13.83,22.61c-.29.48-.62.77-1.15.77h-5.23c-.53,0-.86-.29-1.15-.77l-13.83-22.61h-.53v22.61c0,.48-.24.77-.72.77h-6.14c-.48,0-.77-.29-.77-.77Z"/>
                    <path class="logo-fill" d="M117.5,33.65v5.23c0,.48-.24.72-.72.72h-37.92c-.48,0-.77-.29-.77-.77V6.76c0-.48.29-.77.77-.77h37.68c.48,0,.72.24.72.72v5.23c0,.48-.24.72-.72.72h-30.82v6.77h30.34c.48,0,.72.24.72.72v5.28c0,.48-.24.72-.72.72h-30.34v6.77h31.06c.48,0,.72.24.72.72Z"/>
                    <path class="logo-fill" d="M163.62,6.76v5.18c0,.48-.29.72-.77.72h-16.75v26.16c0,.48-.29.77-.77.77h-5.95c-.48,0-.77-.29-.77-.77V12.67h-16.75c-.48,0-.77-.24-.77-.72v-5.18c0-.48.29-.77.77-.77h41c.48,0,.77.29.77.77Z"/>
                    <path class="logo-fill" d="M208.7,39.6h-7.15c-.58,0-.82-.34-1.15-.86l-2.88-4.46h-26.5l-2.88,4.46c-.34.53-.58.86-1.1.86h-7.2c-.48,0-.82-.38-.38-1.01l20.55-31.83c.29-.48.53-.77,1.06-.77h6.43c.53,0,.82.29,1.1.77l20.5,31.83c.43.62.1,1.01-.38,1.01ZM193.33,27.74l-8.74-13.63h-.62l-8.79,13.63h18.15Z"/>
                    <path class="logo-fill" d="M257.7,14.78v16.03c0,5.47-2.59,8.78-8.54,8.78h-35.33c-.48,0-.77-.29-.77-.77V6.76c0-.48.29-.77.77-.77h35.33c5.95,0,8.54,3.31,8.54,8.78ZM250.12,15.31c0-1.97-.86-2.64-2.64-2.64h-26.79v20.26h26.79c1.78,0,2.64-.67,2.64-2.64v-14.98Z"/>
                    <path class="logo-fill" d="M309.26,39.6h-7.15c-.58,0-.82-.34-1.15-.86l-2.88-4.46h-26.5l-2.88,4.46c-.34.53-.58.86-1.1.86h-7.2c-.48,0-.82-.38-.38-1.01l20.55-31.83c.29-.48.53-.77,1.06-.77h6.43c.53,0,.82.29,1.1.77l20.5,31.83c.43.62.1,1.01-.38,1.01ZM293.89,27.74l-8.74-13.63h-.62l-8.79,13.63h18.15Z"/>
                    <path class="logo-fill" d="M345.11,6.76v5.18c0,.48-.29.72-.77.72h-16.75v26.16c0,.48-.29.77-.77.77h-5.95c-.48,0-.77-.29-.77-.77V12.67h-16.75c-.48,0-.77-.24-.77-.72v-5.18c0-.48.29-.77.77-.77h41c.48,0,.77.29.77.77Z"/>
                    <path class="logo-fill" d="M387.3,39.6h-7.15c-.58,0-.82-.34-1.15-.86l-2.88-4.46h-26.5l-2.88,4.46c-.34.53-.58.86-1.1.86h-7.2c-.48,0-.82-.38-.38-1.01l20.55-31.83c.29-.48.53-.77,1.06-.77h6.43c.53,0,.82.29,1.1.77l20.5,31.83c.43.62.1,1.01-.38,1.01ZM371.94,27.74l-8.74-13.63h-.62l-8.79,13.63h18.15Z"/>
                    <path class="logo-fill" d="M62.01,83.6h-5.57c-.58,0-.96-.29-1.34-.82l-5.38-7.92h-20.55v7.97c0,.48-.24.77-.72.77h-6.14c-.48,0-.77-.29-.77-.77v-32.07c0-.48.29-.77.77-.77h31.59c5.95,0,8.54,3.31,8.54,8.78v7.34c0,4.13-1.49,7.01-4.85,8.16l5.33,8.06c.48.67-.1,1.25-.91,1.25ZM29.17,68.19h22.95c1.78,0,2.69-.67,2.69-2.64v-6.24c0-1.97-.91-2.64-2.69-2.64h-22.95v11.52Z"/>
                    <path class="logo-fill" d="M107.27,77.65v5.23c0,.48-.24.72-.72.72h-37.92c-.48,0-.77-.29-.77-.77v-32.07c0-.48.29-.77.77-.77h37.68c.48,0,.72.24.72.72v5.23c0,.48-.24.72-.72.72h-30.82v6.77h30.34c.48,0,.72.24.72.72v5.28c0,.48-.24.72-.72.72h-30.34v6.77h31.06c.48,0,.72.24.72.72Z"/>
                    <path class="logo-fill" d="M151,50.72v5.23c0,.48-.24.72-.72.72h-30.82v5.81h30.34c.48,0,.72.24.72.72v5.23c0,.48-.24.72-.72.72h-30.34v13.68c0,.48-.24.77-.72.77h-6.14c-.48,0-.77-.29-.77-.77v-32.07c0-.48.29-.77.77-.77h37.68c.48,0,.72.24.72.72Z"/>
                    <path class="logo-fill" d="M156.32,50h6.15c.48,0,.72.29.72.77v32.07c0,.48-.24.77-.72.77h-6.15c-.48,0-.77-.29-.77-.77v-32.07c0-.48.29-.77.77-.77Z"/>
                    <path class="logo-fill" d="M168.23,82.83v-32.07c0-.48.29-.77.77-.77h7.15c.43,0,.62.19,1.06.58l25.35,24h.67v-23.81c0-.48.24-.77.72-.77h6.14c.48,0,.77.29.77.77v32.07c0,.48-.29.77-.77.77h-7.15c-.43,0-.62-.19-1.06-.58l-25.35-24h-.67v23.81c0,.48-.24.77-.72.77h-6.14c-.48,0-.77-.29-.77-.77Z"/>
                    <path class="logo-fill" d="M255.3,77.65v5.23c0,.48-.24.72-.72.72h-37.92c-.48,0-.77-.29-.77-.77v-32.07c0-.48.29-.77.77-.77h37.68c.48,0,.72.24.72.72v5.23c0,.48-.24.72-.72.72h-30.82v6.77h30.34c.48,0,.72.24.72.72v5.28c0,.48-.24.72-.72.72h-30.34v6.77h31.06c.48,0,.72.24.72.72Z"/>
                    <path class="logo-fill" d="M300.33,83.6h-5.57c-.58,0-.96-.29-1.34-.82l-5.38-7.92h-20.55v7.97c0,.48-.24.77-.72.77h-6.14c-.48,0-.77-.29-.77-.77v-32.07c0-.48.29-.77.77-.77h31.59c5.95,0,8.54,3.31,8.54,8.78v7.34c0,4.13-1.49,7.01-4.85,8.16l5.33,8.06c.48.67-.1,1.25-.91,1.25ZM267.49,68.19h22.95c1.78,0,2.69-.67,2.69-2.64v-6.24c0-1.97-.91-2.64-2.69-2.64h-22.95v11.52Z"/>
                    <rect class="logo-fill" width="9.87" height="89.6"/>
                </svg>
            </h1>
            <button id="settings-btn" class="btn btn-secondary">Settings</button>
        </div>
        
        <div class="mb-4">
            <label class="form-label">Output Profile:</label>
            <select id="profile-select" class="form-select"></select>
        </div>
        
        <div id="drop-zone" class="mb-4">
            <p>Drag & drop images here or</p>
            <input type="file" id="file-input" multiple accept="image/*" class="form-control">
            <div class="mt-2">
                <button id="browse-files" class="btn btn-outline-primary">Browse Files...</button>
            </div>
        </div>

        <div id="image-grid" class="row"></div>

        <div class="mt-4 mb-4">
            <div class="mt-3">
                <button id="generate-all" class="btn btn-primary" disabled>Generate All Metadata</button>
                <button id="export" class="btn btn-success" disabled>Export to CSV</button>
            </div>
            <div id="cost-estimate" style="display: none;">
                <h6 class="mb-2">Estimated Cost:</h6>
                <div>Fresh Generation: <span id="fresh-cost">$0.00</span></div>
                <div>With Cache: <span id="cached-cost">$0.00</span></div>
                <small class="text-muted">Based on $0.05/$0.40 per million tokens (fresh) or $0.005/$0.40 per million tokens (cached with GPT-5-nano)</small>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="modal fade" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">API Settings</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="api-key" class="form-label">OpenAI API Key</label>
                        <input type="password" class="form-control" id="api-key" 
                               placeholder="sk-...">
                        <div class="form-text">Key is stored in browser localStorage. Alternatively, set OPENAI_API_KEY in your .env file.</div>
                    </div>
                    <div class="mb-3">
                        <label for="base-path" class="form-label">Base Path for CSV Export</label>
                        <input type="text" class="form-control" id="base-path" 
                               placeholder="e.g., C:/Users/MyName/Pictures">
                        <div class="form-text">If provided, this path will be prepended to image paths in CSV exports</div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="show-cost-estimate" checked>
                            <label class="form-check-label" for="show-cost-estimate">Show Cost Estimates</label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="dark-mode">
                            <label class="form-check-label" for="dark-mode">Dark Mode</label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="saveSettings()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Theme management
        function applyTheme(isDark) {
            document.body.setAttribute('data-bs-theme', isDark ? 'dark' : 'light');
        }

        // Settings handling
        function showSettings() {
            const modal = new bootstrap.Modal('#settings-modal');
            document.getElementById('api-key').value = localStorage.getItem('openai-key') || '';
            document.getElementById('base-path').value = localStorage.getItem('base-path') || '';
            document.getElementById('show-cost-estimate').checked = localStorage.getItem('show-cost-estimate') !== 'false';
            document.getElementById('dark-mode').checked = localStorage.getItem('dark-mode') === 'true';
            modal.show();
        }

        function saveSettings() {
            const key = document.getElementById('api-key').value.trim();
            const showCostEstimate = document.getElementById('show-cost-estimate').checked;
            const basePath = document.getElementById('base-path').value.trim();
            const darkMode = document.getElementById('dark-mode').checked;
            
            if (key) {
                localStorage.setItem('openai-key', key);
            }
            localStorage.setItem('show-cost-estimate', showCostEstimate);
            localStorage.setItem('base-path', basePath);
            localStorage.setItem('dark-mode', darkMode);
            
            document.getElementById('cost-estimate').style.display = 
                showCostEstimate ? 'block' : 'none';
            
            applyTheme(darkMode);
            
            bootstrap.Modal.getInstance('#settings-modal').hide();
            updateCostEstimate();
        }

        function checkApiKey() {
            // Allow processing to proceed - the server will check .env first,
            // then fall back to localStorage if needed
            const hasLocalKey = !!localStorage.getItem('openai-key');
            // Note: We can't check server-side .env from frontend, so we'll let
            // the server handle the API key resolution and show error if needed
            return true; // Always return true, let server handle the validation
        }

        // Cost estimation
        function updateCostEstimate() {
            const imageCount = document.querySelectorAll('.image-card').length;
            if (imageCount === 0) {
                document.getElementById('fresh-cost').textContent = '$0.00';
                document.getElementById('cached-cost').textContent = '$0.00';
                return;
            }

            // Estimate tokens per image
            const inputTokensPerImage = 25000; // system prompt + base64 image
            const outputTokensPerImage = 100; // JSON response

            // Calculate costs for GPT-5-nano
            const inputCostPerMillion = 0.05; // $0.05 per million tokens
            const cachedCostPerMillion = 0.005; // $0.005 per million tokens (90% discount)
            const outputCostPerMillion = 0.40; // $0.40 per million tokens

            const totalInputTokens = inputTokensPerImage * imageCount;
            const totalOutputTokens = outputTokensPerImage * imageCount;

            const freshCost = 
                (totalInputTokens / 1000000 * inputCostPerMillion) +
                (totalOutputTokens / 1000000 * outputCostPerMillion);
            
            const cachedCost = 
                (totalInputTokens / 1000000 * cachedCostPerMillion) +
                (totalOutputTokens / 1000000 * outputCostPerMillion);

            document.getElementById('fresh-cost').textContent = 
                `$${freshCost.toFixed(4)}`;
            document.getElementById('cached-cost').textContent = 
                `$${cachedCost.toFixed(4)}`;
        }

        // Add event listener for settings button
        document.getElementById('settings-btn').addEventListener('click', showSettings);

        // Detect if running in Electron
        const isElectron = window.process && window.process.type;

        // Add API key to all fetch requests
        const originalFetch = window.fetch;
        window.fetch = function(url, options = {}) {
            options.headers = options.headers || {};
            options.headers['X-OpenAI-Key'] = localStorage.getItem('openai-key') || '';
            return originalFetch(url, options);
        };

        const socket = io();

        // Electron-specific functionality
        if (isElectron) {
            const { ipcRenderer } = require('electron');
            
            // Listen for files selected from menu
            ipcRenderer.on('files-selected', (event, filePaths) => {
                // Convert file paths to File objects and handle them
                Promise.all(filePaths.map(filePath => {
                    return fetch(`file://${filePath}`)
                        .then(res => res.blob())
                        .then(blob => {
                            const filename = filePath.split(/[\\\/]/).pop();
                            return new File([blob], filename, { type: blob.type });
                        });
                })).then(files => {
                    handleFiles(files);
                });
            });
            
            // Show notification when processing completes
            window.showElectronNotification = function(title, body) {
                ipcRenderer.send('show-notification', title, body);
            };
        }
        let currentProfile = null;
        let profilesConfig = {};

        // Helper functions
        function generateCategoryOptions(categories, selectedValue) {
            return categories.map(cat => 
                `<option value="${cat}" ${cat === selectedValue ? 'selected' : ''}>${cat}</option>`
            ).join('');
        }

        function createMetadataFields(profile, imageData = {}) {
            return profile.required_fields.map(field => {
                const value = imageData[field] || '';
                if (field === 'category') {
                    return `
                        <div class="mb-3">
                            <label>Category</label>
                            <select class="form-select category-input">
                                ${generateCategoryOptions(profile.categories, value)}
                            </select>
                        </div>`;
                }
                return `
                    <div class="mb-3">
                        <label>${field.charAt(0).toUpperCase() + field.slice(1)}</label>
                        ${field === 'description' ? 
                            `<textarea class="form-control ${field}-input">${value}</textarea>` :
                            `<input type="text" class="form-control ${field}-input" value="${value}">`}
                    </div>`;
            }).join('');
        }

        function updateAllCards() {
            document.querySelectorAll('.image-card').forEach(card => {
                const imagePath = card.dataset.imagePath;
                const existingData = Array.from(card.querySelectorAll('input, select, textarea')).reduce((acc, el) => {
                    acc[el.className.replace('-input', '')] = el.value;
                    return acc;
                }, {});

                card.querySelector('.metadata-fields').innerHTML = 
                    createMetadataFields(currentProfile, existingData);
            });
        }

        // Initialization
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize theme
            const darkMode = localStorage.getItem('dark-mode') === 'true';
            applyTheme(darkMode);
            
            const response = await fetch('/api/profiles');
            const data = await response.json();
            profilesConfig = data.profiles;
            
            const profileSelect = document.getElementById('profile-select');
            profileSelect.innerHTML = Object.entries(profilesConfig).map(([id, profile]) =>
                `<option value="${id}">${profile.name}</option>`
            ).join('');
            
            profileSelect.value = data.default_profile;
            currentProfile = profilesConfig[data.default_profile];
            
            profileSelect.addEventListener('change', () => {
                currentProfile = profilesConfig[profileSelect.value];
                updateAllCards();
            });

            // Initialize cost estimate display
            const showCostEstimate = localStorage.getItem('show-cost-estimate') !== 'false';
            document.getElementById('cost-estimate').style.display = 
                showCostEstimate ? 'block' : 'none';
        });

        // File handling
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            handleFiles(e.dataTransfer.files);
        });
        fileInput.addEventListener('change', (e) => handleFiles(e.target.files));
        
        // Browse files button handler
        document.getElementById('browse-files').addEventListener('click', () => {
            if (isElectron) {
                // Use Electron's native file dialog
                const { ipcRenderer } = require('electron');
                ipcRenderer.invoke('show-open-dialog', {
                    properties: ['openFile', 'multiSelections'],
                    filters: [
                        { name: 'Images', extensions: ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'] },
                        { name: 'All Files', extensions: ['*'] }
                    ]
                }).then(result => {
                    if (!result.canceled) {
                        // Convert file paths to File objects and handle them
                        Promise.all(result.filePaths.map(filePath => {
                            return fetch(`file://${filePath}`)
                                .then(res => res.blob())
                                .then(blob => {
                                    const filename = filePath.split(/[\\\/]/).pop();
                                    return new File([blob], filename, { type: blob.type });
                                });
                        })).then(files => {
                            handleFiles(files);
                        });
                    }
                });
            } else {
                // Fallback to regular file input for web version
                fileInput.click();
            }
        });

        async function handleFiles(files) {
            // Validate files before upload
            const validFiles = [];
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/bmp', 'image/webp'];
            const maxSize = 10 * 1024 * 1024; // 10MB
            const errors = [];

            Array.from(files).forEach(file => {
                if (!allowedTypes.includes(file.type)) {
                    errors.push(`${file.name}: Unsupported file type. Please use JPG, PNG, GIF, BMP, or WebP.`);
                    return;
                }
                if (file.size > maxSize) {
                    errors.push(`${file.name}: File too large. Maximum size is 10MB.`);
                    return;
                }
                if (file.size === 0) {
                    errors.push(`${file.name}: Empty file.`);
                    return;
                }
                validFiles.push(file);
            });

            if (errors.length > 0) {
                alert('Some files were rejected:\\n\\n' + errors.join('\\n'));
            }

            if (validFiles.length === 0) {
                alert('No valid files to upload.');
                return;
            }

            const formData = new FormData();
            validFiles.forEach(file => formData.append('images', file));

            try {
                const response = await fetch('/upload', {method: 'POST', body: formData});
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Upload failed');
                }

                // Clear existing cards and filter duplicates
                const existingPaths = new Set(Array.from(document.querySelectorAll('.image-card')).map(card => card.dataset.imagePath));
                data.images.filter(img => !existingPaths.has(img.full_path)).forEach(createImageCard);
                document.getElementById('generate-all').disabled = false;
                document.getElementById('export').disabled = false;
                updateCostEstimate();
            } catch (error) {
                alert('Upload failed: ' + error.message);
            }
        }

        function createImageCard(image) {
            const col = document.createElement('div');
            col.className = 'col-md-4';
            col.innerHTML = `
                <div class="image-card" data-image-path="${image.full_path}">
                    <img src="${image.full_path}" class="img-thumbnail" style="max-height: 200px;">
                    <div class="metadata-fields">
                        ${createMetadataFields(currentProfile, image)}
                    </div>
                    <div class="mt-2">
                        <button class="btn btn-sm btn-warning generate-single">Regenerate Data</button>
                        <button class="btn btn-sm btn-danger delete-btn" style="margin-left: 8px;">X</button>
                    </div>
                </div>`;

            col.querySelector('.delete-btn').addEventListener('click', () => {
                col.remove();
                updateCostEstimate();
            });
            col.querySelector('.generate-single').addEventListener('click', () => {
                if (!checkApiKey()) return;
                socket.emit('generate_metadata', {
                    full_path: image.full_path,
                    profile: document.getElementById('profile-select').value,
                    settings: {
                        apiKey: localStorage.getItem('openai-key') || ''
                    }
                });
            });

            document.getElementById('image-grid').appendChild(col);
        }

        // Socket.io handlers
        let processingCount = 0;
        
        function updateProgress() {
            const btn = document.getElementById('generate-all');
            btn.textContent = processingCount > 0 
                ? `Processing (${processingCount} remaining)` 
                : 'Generate All Metadata';
            btn.disabled = processingCount > 0;
        }

        socket.on('processing_start', (data) => {
            const card = document.querySelector(`[data-image-path="${data.image}"]`);
            if (card) {
                processingCount++;
                updateProgress();
                card.classList.add('processing');
                card.classList.remove('complete');
            }
        });

        socket.on('metadata_update', (data) => {
            const card = document.querySelector(`[data-image-path="${data.image}"]`);
            if (card && currentProfile) {
                processingCount--;
                updateProgress();
                currentProfile.required_fields.forEach(field => {
                    const input = card.querySelector(`.${field}-input`);
                    if (input) input.value = data.metadata[field] || '';
                });
                card.classList.add('complete');
                card.classList.remove('processing');
                
                // Show notification when all processing is done
                if (processingCount === 0 && isElectron && window.showElectronNotification) {
                    window.showElectronNotification('MetaData Refiner', 'All metadata generation completed!');
                }
            }
        });

        socket.on('error', (data) => {
            processingCount--;
            updateProgress();
            alert(`Error processing ${data.image}: ${data.message}`);
        });

        // Export handling
        document.getElementById('generate-all').addEventListener('click', () => {
            document.querySelectorAll('.image-card').forEach(card => {
                socket.emit('generate_metadata', {
                    full_path: card.dataset.imagePath,
                    profile: document.getElementById('profile-select').value,
                    settings: {
                        apiKey: localStorage.getItem('openai-key') || ''
                    }
                });
            });
        });

        document.getElementById('export').addEventListener('click', async () => {
            const metadata = Array.from(document.querySelectorAll('.image-card')).map(card => {
                return currentProfile.required_fields.reduce((acc, field) => {
                    acc[field] = card.querySelector(`.${field}-input`)?.value || '';
                    return acc;
                }, {full_path: card.dataset.imagePath});
            });

            try {
                const response = await fetch('/export', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        data: metadata,
                        profile: document.getElementById('profile-select').value,
                        base_path: localStorage.getItem('base-path') || ''
                    })
                });
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'metadata.csv';
                a.click();
                a.remove();
            } catch (error) {
                alert('Export failed: ' + error.message);
            }
        });
    </script>
</body>
</html>
